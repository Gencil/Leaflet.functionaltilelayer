<!DOCTYPE html>
<html>
<head>
	<title>Deferred example</title>

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4.5/leaflet.css" />
	<!--[if lte IE 8]><link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4.5/leaflet.ie.css" /><![endif]-->
	<script src="http://cdn.leafletjs.com/leaflet-0.4.5/leaflet.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
	<script src="../src/leaflet.functionaltilelayer.js"></script>	
</head>
<body>

	<div id="map" style="position:absolute;width:80%;height:50%;"></div>

	<script type="text/javascript">

		$(function () {

			var funcLayer = new L.TileLayer.Functional(function (view) {
			    var deferred = new jQuery.Deferred();
			    $.ajax({
			        url: 'http://json.bubblemix.net/ws/EPoap', // mock web service that returns a url template
			        success: function(response) {
			            // Resolve the defered to return the URL
					    var url = response.url
					        .replace('{z}', view.zoom)
					        .replace('{x}', view.tile.row)
					        .replace('{y}', view.tile.column)
					        .replace('{s}', view.subdomain);
			            deferred.resolve(url);
			        }
			    });
			    return deferred;
			}, {
				subdomains: '1234'
			});

			var map = new L.Map('map', { center: new L.LatLng(42.35, -71.05), zoom: 15, layers: [funcLayer] });

		});

	</script>
</body>
</html>